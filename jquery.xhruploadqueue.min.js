/*
 jQuery XHR Upload Queue Plugin
 <https://github.com/stevenbenner/jquery-xhr-upload-queue>
 Copyright (c) 2012 Steven Benner, http://stevenbenner.com/
 Released under the MIT license.
 <https://raw.github.com/stevenbenner/jquery-xhr-upload-queue/master/LICENSE.txt>
*/
(function(a,l){function p(c){function e(){g--;var a=h.shift();a&&(b.length=h.length,b.totalBytesInQueue-=a.size,c.queueChange.call(b));if(a)return g++,a.uploadFile(c.postUrl,c.filesInputName,c.customFormData),!0;0===g&&c.uploadFinish.call(b);return!1}var h=[],i=0===c.acceptedMimeTypes.length,j=RegExp(c.acceptedMimeTypes.join("|")),g=0,b=this;b.length=0;b.totalBytesInQueue=0;b.addFiles=function(f){var d=[],g=b.length,f=a.map(f,function(a){return new q(a,b,e)}),f=c.processFileList.call(b,f),f=a.grep(f,
function(b){if(0===b.size&&!1===c.silenceZeroByteErrors)return b.error=a.fn.xhrUploadQueue.FileError.ZERO_BYTE_FILE,d.push(b),!1;if(!i&&!j.test(b.type))return b.error=a.fn.xhrUploadQueue.FileError.UNACCEPTED_MIME_TYPE,d.push(b),!1;if(b.size>=c.maximumFileSize)return b.error=a.fn.xhrUploadQueue.FileError.FILE_TOO_LARGE,d.push(b),!1;if(g>=c.maximumQueueSize)return b.error=a.fn.xhrUploadQueue.FileError.QUEUE_FULL,d.push(b),!1;g++;return!0});0<d.length&&c.handleUnacceptedFiles.call(b,d);a.each(f,function(a,
d){h.push(d);b.length=h.length;b.totalBytesInQueue+=d.size;c.queueAdd.call(b,d);c.queueChange.call(b)})};b.removeFile=function(a){for(var d=0,d=0;d<h.length;d++)if(h[d]===a)return h.splice(d,1),b.length=h.length,b.totalBytesInQueue-=a.size,c.queueRemove.call(b,a),c.queueChange.call(b),!0;return!1};b.emptyQueue=function(){h=[];b.length=0;b.totalBytesInQueue=0;c.queueChange.call(b)};b.beginUpload=function(){c.uploadStart.call(b);var a=c.uploadConcurrency;for(g=a;0<a--;)e()};b.isUploadInProgress=function(){return 0<
g}}function q(c,e,h){var i=a.noop,j=a.noop,g=a.noop,b=a.noop,f=null,d=this;d.file=c;d.size=c.size;d.name=c.name;d.type=c.type;d.error=null;d.beginSend=function(b){i=b};d.progress=function(b){j=b};d.endSend=function(b){g=b};d.sendFail=function(a){b=a};d.uploadFile=function(c,e,k){var n=new FormData,l=0,m=a.now();i.call(d);n.append(e,d.file);k&&a.each(k,function(b,a){n.append(b,a)});f=a.ajax({url:c,data:n,cache:!1,contentType:!1,processData:!1,type:"POST",xhr:function(){var b=new window.XMLHttpRequest;
b.upload.addEventListener("progress",function(b){if(b.lengthComputable){var c=a.now(),e=(b.loaded-l)/((c-m)/1E3);m=c;l=b.loaded;j.call(d,b,e)}},!1);return b}});f.done(function(b){g.call(d,b)});f.fail(function(a,c){b.call(d,a,c)});f.always(h)};d.cancelUpload=function(){null!==f&&f.abort()};d.removeFromQueue=function(){e.removeFile(d)}}function k(a){a.stopPropagation();a.preventDefault()}var m=window.FileReader!==l,o=(new window.XMLHttpRequest).upload!==l;a.fn.xhrUploadQueue=function(c){if(!this.length)return this;
var e=a.extend({},a.fn.xhrUploadQueue.defaults,c);if(!m||!o)return this.removeClass(e.fullSupportClass),this.addClass(e.noSupportClass),m||this.addClass(e.noFilesAPIClass),o||this.addClass(e.noXHR2Class),e.noSupport.call(),this;this.addClass(e.fullSupportClass);return this.each(function(){var c=a(this),i=new p(e);c.data("fileQueue",i);e.init.call(i);if(!0===e.hookDragAndDrop)c.on({dragenter:function(a){k(a);c.addClass(e.hoverClass);return!1},dragover:function(a){k(a);c.addClass(e.hoverClass);return!1},
dragleave:function(a){k(a);c.removeClass(e.hoverClass);return!1},drop:function(a){k(a);c.removeClass(e.hoverClass);i.addFiles(a.originalEvent.dataTransfer.files)}});if(c.is("input[type=file]"))c.on("change",function(){i.addFiles(this.files)}),0<e.acceptedMimeTypes.length&&c.attr("accept",e.acceptedMimeTypes.join(","));else{var j=c.find("input[type=file]");j.on("change",function(){i.addFiles(this.files)});0<e.acceptedMimeTypes.length&&j.attr("accept",e.acceptedMimeTypes.join(","))}if(c.is("form"))c.on("submit",
function(){i.beginUpload();return!1})})};a.fn.xhrUploadQueue.defaults={maximumQueueSize:10,maximumFileSize:1048576,uploadConcurrency:2,acceptedMimeTypes:[],postUrl:"upload.php",filesInputName:"filesinput",hookDragAndDrop:!0,customFormData:null,silenceZeroByteErrors:!0,hoverClass:"draghover",fullSupportClass:"fullsupport",noSupportClass:"nosupport",noFilesAPIClass:"nofilesapi",noXHR2Class:"noxhr2",init:a.noop,queueAdd:a.noop,queueChange:a.noop,queueRemove:a.noop,handleUnacceptedFiles:a.noop,uploadStart:a.noop,
uploadFinish:a.noop,noSupport:a.noop,processFileList:function(a){return a}};a.fn.xhrUploadQueue.FileError={QUEUE_FULL:"The upload queue is full",FILE_TOO_LARGE:"The file is too large",UNACCEPTED_MIME_TYPE:"That type of file is not accepted",ZERO_BYTE_FILE:"File is empty, or is a folder"}})(jQuery);